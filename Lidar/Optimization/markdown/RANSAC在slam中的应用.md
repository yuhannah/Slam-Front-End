# RANSAC在slam中的应用

在`se2_l2_ransac.cpp`文件中的：

```c++
bool TFEST_IMPEXP se2_l2_robust(
			const mrpt::utils::TMatchingPairList &in_correspondences,
			const double               in_normalizationStd,
			const TSE2RobustParams   & in_ransac_params,
			TSE2RobustResult         & out_results
			);
```

目的：根据输入的配对点集合，采用随机一致性采样方法，从中随机选取两对基础配对点对儿形成子集，逐渐扩空子集数量，直到子集中的配对点对儿满足相同的位姿条件，记录当前子集；不断根据随机配对点对儿生成一致性子集，最后根据RMSE值最小的子集作为最优的子集，并计算出该子集对应的位姿和协方差矩阵，作为输入配对点集合的采样后的优化结果。

输入：配对点集合

输出：随机一致性采样后的位姿

流程：

- 遍历输入的配对点集合，分别找到this和other部分的最大序号
- 遍历输入的配对点集合，找到不重复序号（unique）的配对点对数
- 循环iters次迭代过程，首先随机化输入的配对点集合的顺序
- 遍历随机后的配对点集合，跳过已经接受的this或者other点的配对点对儿
- 添加最初的两组满足不重复条件的配对点对儿
- 如果上述两组配对点对儿的this点间距和other点间距小于阈值，且计算的解析解协方差矩阵小于阈值，则接受这两组配对点对儿作为采样集合的基础
- 继续遍历随机后的配对点集合，将other点按照上述解析解位姿投影到this空间，与this点计算`mahalanobis`距离，如果满足阈值，则接受该配对点对儿
- 当接受的子集中一致的配对点对儿数满足阈值条件或者遍历完全部配对点对儿，则结束本次遍历
- 如果接受的子集中一致的配对点对儿数满足阈值条件，则根据子集计算解析解和协方差矩阵，以及RMSE误差值；如果不满足阈值条件，则重置RMSE误差值
- 如果接受的子集中一致的配对点对儿数满足阈值条件，则遍历所有已经添加的子集的集合，如果找到该子集已经添加，则增加该子集的权重；如果没有添加，则将该子集添加到子集的集合中，并计算权重
- 如果允许动态调节外层迭代次数，则计算动态迭代次数
- 如果当前子集满足最小RMSE条件则记录当前子集为最大子集
- 如果当前子集满足外层迭代结束条件，则结束外层迭代；继续下一次外层迭代过程
- 所有迭代完成后，输出最终一致性结果