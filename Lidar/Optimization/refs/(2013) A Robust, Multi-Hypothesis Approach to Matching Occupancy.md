# (2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy Grid Maps

 # 一种鲁棒的多假设的占用栅格地图匹配方法 

## ABSTRACT

本文提出了一种新的匹配方法，通过寻找地图中检测到的一组稀疏特征之间的对应关系来匹配占有率栅格地图。这个问题在这里作为通用图像配准的一个特殊实例来说明。为了解决网格地图匹配过程中的不确定性和模糊性，提出了一种改进的RANSAC算法，该算法通过搜索特征对的动态数目的内部一致子集来计算地图之间的平移和旋转假设。通过提供地图相对姿态的（可能是多模态）概率分布，我们的方法可以无缝地集成到移动机器人的大规模地图框架中。本文提供了不同检测器和描述符的基准测试，以及大量的实验结果，证明了该算法的稳健性，对于从四个公开数据集获得的本地地图之间的1700次匹配，环路闭合检测的成功率为97%。

## INTRODUCTION

近三十年前引入移动机器人领域的占有网格地图[11]，是平面环境地图构建的一种非常有价值的几何表示[15，16，36]。在这个表示中，空间被安排成一个度量网格，每个网格存储被障碍物占据的概率。这些地图可用于大规模混合度量拓扑地图模型的上下文中[5、8、12]，其中拓扑图的每个节点表示一个局部度量地图，例如一组可视地标或网格地图。

层次映射方法的一个重要要求是检测两个局部地图是否对应于同一物理位置，并在这种情况下计算这些地图之间的相对转换（即检测循回路闭合）。解决分层框架中的回路闭合问题，即本文提出的方法的目的，意味着要应对许多障碍，如机器人传感器中的噪声、模糊性（环境的不同部分可能无法区分）和动态场景（一个区域的地图可能会随时间而改变）。

我们没有单独使用栅格地图，而是采用了局部地图的双重表示法，其中同时维护占用栅格地图和点地图。如[29]所述，这种方法有许多优点，因为这些地图相互补充，它们的维护只需要用相同的传感器数据同时更新两个地图。

与这种对偶表示相对应，我们的一对局部地图的对齐方法包括两个不同的步骤：（i）首先在没有任何先验信息的情况下对网格地图进行匹配，然后（ii）点地图有助于改进匹配。我们的讨论将突出地集中在第一步，即网格到网格的匹配，因为点地图的配准是一个很好理解的话题，有高效的解决方案，如ICP[2]。此外，第二步只需改进已经接近实际解决方案的估计，而网格到网格的匹配没有这样的优势，因此提出了一个更具挑战性的问题。

我们提出通过配准对应的地图图像、对应的将网格单元解释为像素和将占用概率解释为灰度所产生的灰度图像来估计一对网格地图之间的转换。由于在机器人应用中，我们可以选择网格单元大小，因此我们可以只关注具有相同单元大小的匹配地图。因此，一对地图只能通过一个完全由二维平移加旋转决定的刚性变换来关联，而不考虑比例尺的变化。

一般来说，图像配准技术可以分为基于强度的配准技术和基于兴趣点提取的配准技术，参见文献[38]进行广泛的综述。尽管前一种方法已经被应用于网格地图匹配[16]，但之前没有基于特征提取的工作，因为特征提取在计算上更有效，因此更适合于集成到实时地图框架中。尽管存在以前的作品致力于分析不同的视觉特征检测器（14）和描述符[27 ]的性能，但我们在这项工作中提出了一个基准，具体地解决在栅格地图图像中它们的行为。

我们的方法是一个重要的贡献，因为报告了一个稳健的方法用高斯和（SOG）的方式来寻找地图图像之间的转换形式。这种概率表示允许处理多个假设，因此可以一致地将该方法集成到机器人映射框架中，其中大多数基于概率贝叶斯推理[37]。因此，我们的概率方法与以往在变换参数空间中基于投票计数的鲁棒图像配准的工作相比不同[33]。在移动机器人技术中，Duckett和Nehmzow[10]报告了一种与我们非常相似的方法，该方法还获得了网格地图之间潜在匹配的SOG。然而，他们的工作假设对机器人的绝对方位有准确的了解（即机器人应该配备指南针），因此我们的建议对实际情况具有更广泛的适用性。

由于地图合并问题可以看作是单机器人建图中检测回路闭合的一个特殊实例，因此本文的工作也与多机器人建图的研究有关。在这个领域中，一个与我们的目的类似的方法已经在[3]中被报道，但是它没有考虑在地图合并中有多个假设的可能性，并且对典型的执行时间的粗略比较显示我们的方法大约快100倍。

文章的其余部分安排如下。在下一节中，我们将概述我们的方法。然后在第3节和第4节中分别对不同的检测器和描述符进行了详细的讨论，这些检测器和描述符在第5节中进行了基准测试。第6节中讨论的鲁棒匹配方法需要高斯模型来实现对应子集的最优刚性变换，这在第7节中讨论。最后，实验结果用四个公开数据集的地图验证了我们的方法。我们必须指出，在开源GNU通用公共许可证1下发布了该算法的C++实现。

## OVERVIEW

图1总结了我们的总体方法。首先，对地图图像进行预处理，以消除栅格地图中常见的高频噪声。然后在这些过滤后的图像中检测兴趣点（特征）并计算描述符以模拟其周围环境。显然，特定兴趣点检测器和描述符的选择将决定我们整个方法的性能。经过全面的实验（参见第5节的讨论），我们确定了**Harris[17]或Kanade Lucas Tomasi（[24，34]）检测器，以及由以特征为中心的圆形片组成的描述符，在最大化显著性和降低计算成本方面提供最佳性能。**

一旦从地图图像中提取了特征，两个图像中的特征之间的所有候选对应C的集合通过其描述符之间的相似性度量来确定（如第4.2节所述）。由于地图的模糊性，一个给定的特征通常有几个候选对应。**改进的RANSAC算法通过施加唯一性（每个特征在另一个映射中只能对应一个）和刚性变换约束（两个映射中特征的相对位置必须相同），从所有这些候选中获得内部一致假设Ci⊂C的子集。**所有变量的不确定性在整个过程中都被考虑在内，因此所有的决策都是在随机测试的基础上做出的。**与标准RANSAC算法[13]不同，我们提出不仅保留支持内联数最大的解，而且保留动态内联数。**

![1]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/1.png)

图1：地图匹配方法的概述，该方法将一对地图对齐，每对地图包含一个栅格地图和一个点地图。首先对网格地图进行配准，得到一组潜在的位姿变换q，然后利用点地图和基于ICP的对齐对其进行细化。结果是实际q的高斯混合的形式的概率密度分布。

每一个被检测到的假设都会导致一个特定的刚性变换，这个变换被建模为平移和旋转空间上的高斯分布。

两个地图之间的刚性变换q的概率分布的一般形式，作为高斯和（SOG），可以写为：
$$
p({\rm q})=\sum_i {\cal N} ({\rm q};{\rm q}_i^*,{\rm Q}_i)\omega_i
$$
其中，每个$\omega_i$对以${\rm q}_i^*$为中心且协方差矩阵为${\rm Q}_i$的高斯核加权，并且$\sum_i \omega_i=1$。分布$p({\rm q})$也可以用所有潜在对应集Ci上的全概率公式展开，如下所示：
$$
p({\rm q})=\sum_{\forall {\cal C}_i}p({\rm q}|{\cal C}_i)P({\cal C}_i)
$$
比较上述两个公式，我们可以选择$P({\cal C}_i)$作为SOG权重$\omega_i$，并将${\rm q}$的密度（给定一组对应集Ci）建模为高斯分布，即：
$$
p({\rm q}|{\cal C}_i)={\cal N} ({\rm q};{\rm q}_i^*,{\rm Q}_i)
$$
该分布的参数（其平均值和协方差）将在第7节中推导。

最后，我们应该指出我们的建议，**简化由RANSAC阶段产生的SOG分布。**这意味着，只要有可能，两个或多个高斯被一个具有适当均值和协方差的高斯所代替，使得它比原来的一对更紧密地覆盖相同的体积。我们将遵循Runnalls[30]提出的方法：只有那些初始和暂定简化密度之间的Kullback-Leibler散度（KLD）低于阈值的简化才被允许。简化SOG的一个原因是尽可能地降低以下细化步骤的成本，在该步骤中，将ICP[2]应用于点地图，以改进平均地图变换的估计$q^*$。然后对得到的SOG进行再次测试，以进一步简化，获得地图变换的最终密度分布（可能是多模态密度分布）。

## EXTRACTION OF FEATURES

在本节中，我们回顾了一些著名的图像特征检测器，并提出了对地图图像进行预处理以改进检测过程的需求。

### INTEREST-POINT DETECTORS

在典型的室内居住网格地图中，我们可以很容易地识别由场景元素产生的自然特征，如角、柱或通常任何锐利的边缘。它们也出现在一些由立杆、建筑角落、车辆边缘等形成的室外地图中。这些自然地标适合匹配相同区域的地图，因为它们自然出现在环境中，并且通常是静态的。

所有这些兴趣点可以通过将栅格地图解释为灰度图像、地图图像和应用现有的关键点检测器来检测。任何检测器最理想的特性是它的可重复性，即当它出现在不同的图像中时，它能够检测到给定的特征。

我们对以下四种方法的性能感兴趣：

- Harris检测器[ 17 ]，它搜索结构张量有两个大特征值的点，揭示角点的存在。
- Kanade-Lucas-Tomasi（KLT）方法（[24,34]）也依赖于结构张量。它检测特征值之一超过给定阈值的显著点。
- SIFT算法的检测阶段[23]，它识别高斯差分金字塔中的尺度空间极值。该方法旨在检测斑点而不是角点[26]。
- 基于Hessian矩阵的近似的SURF检测器[1 ]。

地图图像中存在着影响特征检测过程的问题，需要进行适当的处理。激光测距扫描的网格映射通常会在地图中产生一些伪影，这些伪影可以解释为图像中的高频噪声（例如，由扫描的一条射线产生的噪声）。为了防止在自由空间中间检测到虚假兴趣点，我们提出先用高斯滤波器，然后用中值滤波器对图像进行预处理，以减弱大部分的不规则性。接下来我们将解释如何调整每个滤波器以获得最佳的检测性能。

### CHARACTERIZATION

此特性描述中使用的地图集（在线2）由10对来自真实机器人数据的网格地图组成。我们必须注意的是，这些地图代表了真实的回路闭合情况，由于噪声和机器人的不同视角，网格部分重叠，差异很小。由于在每个网格中检测到数百个关键点，从统计角度来看，我们的总体特征可以被认为是重要的。

为了评估每个感兴趣点检测器的重复性，我们将其应用于每对图中的两个图，然后计算共同检测特征的数量，即必须在两个网格图中检测相同的特征。然后，通过人工计算地图对之间的地面真值变换，得到正确的对。为了避免由于检测点的数量而导致的结果偏差，我们将兴趣点的数量限制为与每个栅格地图的扩展成比例的固定值（每平方米0.015个特征的典型值适用于我们比较中使用的所有地图）。

图2总结了每个检测器的结果，对于不同的Wg和Wm值，高斯滤波器和中值滤波器的大小。在每种情况下，值Wg＝0和Wm＝1对应于空滤波器，因此也考虑了仅应用其中一个滤波器（或不应用任何滤波器）的情况。

![2]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/2.png)

图2：测量每个探测器的重复性，以及用于平滑地图图像的高斯（Wg）和中值（Wm）滤波器的不同大小。较亮的颜色表示在两个地图中检测到的公共特征的数量较多。

观察blob检测器（SIFT和SURF）如何在较大的滤波尺寸（导致更多的“软化”图像）下表现良好，而角点检测器（Harris和KLT）对于稍微过滤的图像或甚至对于完全未过滤的地图具有良好的重复性（参见图2中的KLT结果）。图3显示了每个检测器所需的不同滤波器的示例，以实现最佳性能。在第5.1节中给出的基准测试中采用了每个探测器的最佳滤波器配置，图6（f）中显示了相应的匹配总数。

![3]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/3.png)

图3：数据集中的一张地图，分别用大小为Wg和Wm的高斯和中值滤波器过滤。对于Harris和SIFT检测器，检测到的兴趣点用小正方形标记。注意每个方法如何检测不同类型的特征（角点或斑点），因此需要不同的滤波要求。

## DESCRIPTORS

### REVIEW

一旦关键点被检测到，它们就被分配不同的描述符以建立对应关系。我们研究了以下五个图像描述符的性能3：

- SIFT：该方法基于图像梯度直方图[23]，得到一个128长度的描述向量。
- SURF：基于Haar小波的响应，如[1]所述。
- 强度域自旋图像（自旋）：强度和距离的二维直方图〔22〕，由参数Rmax确定的兴趣点的最大半径。使用距离（不考虑角度）可以使描述符保持旋转不变。
- 线性或对数圆形片：这两个描述子有许多相似之处，因此我们在这里一起讨论它们。两者都将以兴趣点为中心的半径Rmax的圆形区域映射到极坐标的2D矩阵（描述符）中。该矩阵用f（u，v）表示，其中u和v分别代表与特征的距离和角度的不同值。其思想是在表示中提取特征邻域的圆形面片，该面片对旋转不是不变的，但这些旋转在角度维度（v）中只是移动，如图4（b）–（c）中的示例所示。线性极性描述符（简称lin polar）与其对数形式（log polar）之间的唯一区别是在距离中使用线性或对数刻度。

![4]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/4.png)

图4：不同方向的特征匹配示例。（a）在地图a中突出显示任意参考特征f1a，并在地图b中标记两个潜在的配对f1b（真实对应）和f2b。（b）–（c）对于分别使用线性极性和对数极性描述符的情况，特征描述符之间的相似性显示为距离函数$d(f_i,f_j,\Delta \phi)$。请注意，实际对应的f1a-f1b接近180°相对旋转时的最小距离。我们必须指出，在这幅图中，已经评估了数百个不同的离散方向，目的是产生一个清晰的说明，而实际上，只有8个离散方向就足以实现出色的区分。

接下来，我们将讨论度量描述符之间相似性的问题，这是评估它们的显著性的必要条件。

### A SIMILARITY FUNCTION BETWEEN DESCRIPTORS

对于地图a和地图b中的两个关键点i和j，给出一对fia和fjb描述符，我们有兴趣测量它们的相似性。对于SIFT、SURF和Spin描述符，最自然的度量是**描述符向量之间的欧几里德距离**。然而，lin-polar和log-polar这两种情况并不是方向不变的，值得进一步讨论。

如图4所示，两个匹配特征的描述符只因角度尺寸的偏移而不同。因此，我们建议通过两个描述符f i和f j之间的欧几里德距离来测量它们之间的距离，给定一个旋转$\Delta \phi$，即：
$$
d({\rm f}_i,{\rm f}_j,\Delta \phi)=\left(\sum_u \sum_v |{\rm f}_i(u,v)-{\rm f}_j(u,v+\Delta \phi)|^2 \right)^{\frac{1}{2}}
$$
其中角极坐标v取对应矩阵大小的模。

通过计算公式（4）中到一对描述符fia和fjb的距离，我们得到了方向$\Delta \phi$中每个可能位移的距离向量。如图4所示，当两个特征真正匹配时，这些距离向量对于真实方向具有明显的最小值，因此我们建议在lin-polar和log-polar的情况下测量特征间距离，如下所示：
$$
d({\rm f}_i,{\rm f}_j)=\min \limits_{\Delta \phi}d({\rm f}_i,{\rm f}_j,\Delta \phi)
$$
对于我们比较中的所有描述符，我们都有到范围[0，1]的标准化距离，以便在下一节中显示的结果中保持均匀性。

## EVALUATION OF DETECTORS AND DESCRIPTORS

### BENCHMARK

在第4.2节中定义了描述词对的相似性度量之后，我们感兴趣的是获得两个地图a和b的特征之间的一组候选对应关系，给定它们的描述词fia和fjb。必须评估所有潜在对应关系的优度，例如只有最有希望的配对（通过给定测试的配对）才被视为候选。每个特征在另一个映射中具有多个潜在对应是可以接受的，因为随后的鲁棒匹配步骤（如RANSAC[13]）可以容易地管理该模糊性。

可以说，选择匹配的最简单测试是阈值化，在我们的例子中，这意味着仅当它们的描述符之间的距离dij小于固定值Td时，才接受fia和fjb之间的潜在匹配。然而，这种简单的方案在网格匹配的背景下有一些缺点，因为实际对应对之间的距离值可能在相对较大的范围内变化。因此，涵盖大多数良好对应关系的任何允许阈值Td都将遭受较高的误报率。

遵循类似于Lowe在[23]中的建议的思想，我们引入了建立候选对的第二个条件：关联距离dij不仅必须低于阈值Td，而且必须足够接近地图b中fia的最佳匹配，即对于j的所有值，dij的最小值（参见图5）。这种限制的特征在于第二阈值Tδ，它表示潜在配对和最佳配对之间的最大可接受距离δ，即δij= dij - minj dij。注意，对于极端情况Tδ=0，每个特征只与另一个映射中的一个相关：具有最接近描述符的一个。为了清楚起见，在图5中用一个示例说明了度量dij和δij。

![5]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/5.png)

图5：描述符dij和索引δij之间距离的示意图，该距离测量相对于每个给定特征i的最接近的一个的距离。注意，根据定义，最佳配对总是被赋予一个值δij=0。只有低于阈值Td（绝对）和Tδ（相对于最小距离）时，才接受配对。

通过一个基准测试，从一个由10对具有已知真值的子图组成的训练集以及多个检测器和描述符的组合中获得阈值Td和Tδ的最优值。最佳阈值是通过最小化将对应特征误分类为有效或无效候选的概率Perr来确定的，具体如下：

$$
\begin{align}
P_{err}(T_d,T_{\delta}) &= P(w)P_{err}(T_d,T_{\delta}|w)+P(v)P_{err}(T_d,T_{\delta}|v)\\
&= P(w)P(d_{ij}<T_d,\delta_{ij}<T_{\delta}|w)\\
&+ P(v)[1-P(d_{ij}<T_d,\delta_{ij}<T_{\delta}|v)]
\end{align}
$$
它可以根据节点密度p（d，δ| v）和p（d，δ| w）来评估，其中v和w分别代表有效和错误的对。注意到当（i）距离dij通过两个阈值并且它是一个错误的关联（总和中的第一项）或者（ii）有效的配对不通过阈值（第二项）时，将发生错误分类，可以很容易地导出上面的表达式。对于我们的分析，我们假设没有关于有效或无效配对概率的先验信息，因此我们得到P（v）=P（w）=1/2。联合条件密度p（dij，δij | v）和p（dij，δij | w）是通过计算10对子映射中的所有潜在对生成的直方图来估计的，分别为220个有效对应和24万个无效对应。

基准测试的结果总结在图6（e）中，图6（e）显示了特征检测器和描述符的每一种组合所能达到的最小分类误差Perr，以及相关的平均计算时间（对于整个子映射）。这些时间包括检测、描述符提取和距离计算，但不包括第3.2节中讨论的预处理过滤器。**这种预处理将平均增加10到200毫秒，与SIFT和SURF相关的计算负担更大，因为它们需要比Harris或KLT方法更大的过滤内核。**

请注意，对于那些由最大半径Rmax参数化的描述符（见第4.1节），我们只针对最小化分类错误的值给出结果。但是，这是一个非关键参数，因为1-3米范围内的任何值都会给出非常相似的结果。线性极性和对数极性描述子的角分辨率和径向分辨率分别设置为8和6格。增加这些参数在理论上会使它们更加独特，但在实践中影响很小，因此我们采用了不会显著降低性能的最小值。

![6]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/6.png)

图6：网格地图匹配的特征检测器基准。（a）–（d）四个不同阈值Td和Tδ的预期Perr示例。最小误差点在每个图形中用十字标记。我们还在每个子图的右侧展示了有效（v）和错误（w）关联的距离d的边际条件分布，以及距离差δ的边际条件分布。（e）对于检测器和描述符的每个组合，其最佳阈值（即用（a）–（d）叉号标记的阈值）的分类错误的总概率Perr，以及一个map的平均计算时间。（f）测量每个探测器的重复性。

### DISCUSSION

从我们的比较中我们可以得出的第一个重要结论是，没有一个描述子将有效对与错误对区分开来的分类误差能够在20%以下，这显然是由于地图图像中的许多特征在局部看起来非常相似而导致的。尽管如此，丢弃80%的错误配对对后续的稳健匹配算法（见第6节）提供了无价的改进，因为它将不得不处理少量的异常值。

值得注意的是，当针对Harris或KLT检测器定位的兴趣点（条形图中的第三到第六个值）进行计算时，SIFT和SURF描述符的性能要比按照其原始方法（图中的前两个值）进行计算时差得多。如第3.1节所述和图6（f）所示，这对这些描述符在网格匹配中的实际适用性具有重要影响，因为原始的SIFT和SURF检测器比Harris和KLT方法具有更差的重复性。随后，我们放弃使用这两个描述符作为最佳解决方案，因为它们导致的错误率（Perr）与其他描述符非常相似，同时严重减少了匹配点的数量，并意味着更高的计算负担，如图6（e）所示。

在图6（a）–（d）中，它表示了一些选定方法的计算Perr（Td，Tδ），这些方法沿着我们在基准中获得的边际分布。观察所有方法的边缘p（δij | v）如何在原点（δij=0）呈现清晰的峰值，这表明最接近的特征通常是实际对应4。然而，情况并非总是如此，因此最佳Tδ值并不完全为零。

请注意，Perr（0.5，在图中用白色表示）的最差获得值是在很宽的阈值范围内获得的，而更低的错误率只出现在参数的某一波段（用较暗的区域表示）。这些带的厚度与描述符的显著性有关，这可以从有效和错误对的描述符距离密度（每个Perr图右手边的直方图）中观察到。例如，比较SURF的直方图p（d | v）和p（d | w）以及图6（a）-（c）中的自旋描述符，其中很明显SURF中的直方图集中在相对不同的区域（简化阈值放置位置的决定），而自旋描述符的情况并非如此。

作为我们基准测试的最终结论，lin-polar和log-polar描述子都具有几乎相同的性能，它们由于降低了误分类概率和更快的计算时间而成为与Harris或KLT检测器相结合的网格匹配的最佳选择。

## CONSTRUCTION OF THE SOG： THE MODIFIED RANSAC ALGORITHM

一致的相关点的子集C i ∈ C可以通过RANSAC提取出来，RANSAC是一种基于一致性的内点与外点区分方法[13]。然而，在我们的问题中，由于网格匹配中的模糊性可能导致多个互不兼容但内部一致的子集C i，因此仅保留大多数支持内联的假设是不够的。我们建议将这些假设中的每一个保持为SOG中的高斯模式（参见方程（2）），因此需要修改RANSAC算法以允许存在多个假设。
![algorithm-1]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/algorithm-1-1575425871152.png)
接下来，我们描述完整的过程，为了清楚起见，算法1中也指定了该过程。首先，从C中随机选择两个对应项（确定相关映射变换p（q | C i）的分布所需的最小数）来初始化子集Ci={ck1，ck2}（算法的第4行）。首先对**唯一性**约束进行检验，即在有效的配对中，给定的特征不能同时出现在对应的ck1和ck2中。然后，通过卡方检验（第5行）来检验该对的可行性，该卡方检验检测在两个地图a和b中测量的特征间空间距离da和db之间的不一致（参考图7（a）中的示例）。

![algorithm-1-4,5]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/algorithm-1-4,5.png)

如附录所示，如果下式成立，我们可以接受距离在c的置信范围内是一致的，其中$\chi^2_{n,c}$代表n自由度的逆卡方累积分布。
$$
\frac{(d^2_a-d^2_b)^2}{8\sigma^2(d^2_a+d^2_b)}<\chi^2_{1,c}
$$
接下来，必须确定支持由每组初始对儿C i定义的假设p（q | Ci）的内联数。这是通过在地图b中的所有特征和由q变换的地图a中的所有特征之间建立关联来实现的。请注意，这是一个随机数据关联问题，因为所有特征位置和变换本身都具有关联的不确定性。

一种用于随机数据关联的鲁棒方法是联合兼容性分支定界（JCBB）[28 ]，但不幸的是，它的指数时间复杂度使得它对于我们的问题是不切实际的，其中每个地图通常包含大约一百个特征。

我们的另一种选择，在算法1中详细说明，包括顺序合并（第12-19行）匹配，优化两个高斯积的积分，这可以解释为两个点在空间中共享相同位置的可能性，也就是配对的**匹配可能性**[7]。当下一个最佳配对候选者（i，j）的马氏距离平方$D^2_M(i,j)$高于给定的阈值$\chi^2_{c,2}$时，内环的合并停止。

![algorithm-1-12-19]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/algorithm-1-12-19.png)

如[18]所述，当发现新的inliner时，上述过程被重复多次动态更新。对于SOG的权重，每个高斯模式最初被分配一个单位权重，当在随后的迭代中发现相同的对应子集时（第6-8行），该单位权重将递增。这种方法的一个优化是测试两个第一对应项C i是否已经是另一个C j的一部分，在这种情况下，增加权重ωj。通过观察前两对不同但属于最后一个子集的自洽对，证明了该启发式方法的正确性。

![algorithm-1-6-8](../Pictures/algorithm-1-6-8.png)

注意，为了接受一个假设（算法的第20行），需要存在最小数目的内联M。在我们的实验中，这个阈值被启发式地设置为每个地图中发现的特征平均数的15%。这种限制防止了当两个地图不真正匹配时，由于纯偶然性而导致的支持内联极为少的虚假假设的检测。

![algorithm-1-20]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/algorithm-1-20.png)

## UNCERTAINTY OF THE OPTIMAL TRANSFORMATION

给定一组地图对应的点对应关系，众所周知，在最小均方误差（LMSE）意义下（2, 20, 25）中存在一个封闭形式的解，用于找到它们之间的刚性变换。我们在这里提供了与此最优解相关的不确定性的推导，目的是使我们的公式在概率定位和建图框架中可用。考虑到这种不确定性是必要的，因为任何特征的位置总是容易出错，主要是因为地图的离散性和兴趣点探测器的有限精度（按大约一个像素，也就是说，一个网格单元的大小-在移动机器人栅格地图中通常在5到20厘米）。此外，地图上特征的空间分布对于转换的精度至关重要，如本节末尾所述。

给定一组特定的特征对应项C i，我们将地图之间的刚性变换${\rm q}=[x \, y \, \phi]^{\top}$的概率密度建模为高斯分布，即：
$$
p({\rm q}|{\cal C}_i)={\cal N}({\rm q};{\rm q}^*_i,{\rm Q}_i)
$$
其中，q⋆i和Qi分别表示相应的均值和协方差矩阵。下面，我们推导出这个分布的参数的表达式。其基本思想是将地图变换的最优解作为高斯均值，而协方差矩阵通过所产生函数的一阶泰勒级数逼近的不确定性传播来近似，如下所述。

设${\rm p}^a_k=[x^a_k \, y^a_k]^{\top}$和${\rm p}^b_k=[x^b_k \, y^b_k]^{\top}$分别为第k个特征在地图a和地图b中的位置。然后，给定一组对应关系Ci，即每个地图中的地图特征索引对（ia，ib），我们可以将任何刚性变换q的特征匹配的平方误差定义为：
$$
E_{C_i}({\rm q})=\sum \limits_{\forall (i_a,i_b) \in {\cal C}_i}|{\rm p}^b_{i_b}-({\rm q} \oplus {\rm p}^a_{i_a})|^2
$$
其中⊕表示姿势合成运算符[4]。在二维情况下，通过将等式（9）相对于变换q的导数等于零，可以得到使该误差最小化的最优变换${\rm q}^*_i=[x^*_i \, y^*_i \, \phi^*_i]^{\top}$，从而得到闭式解[25]：

![eq-10]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/eq-10.png)

```c++
// Non vectorized version:
float SumXa=0, SumXb=0, SumYa=0, SumYb=0;
float Sxx=0, Sxy=0, Syx=0, Syy=0;

for (TMatchingPairList::const_iterator corrIt=in_correspondences.begin(); corrIt!=in_correspondences.end(); corrIt++)
{
    // Get the pair of points in the correspondence:
    const float xa = corrIt->this_x;
    const float ya = corrIt->this_y;
    const float xb = corrIt->other_x;
    const float yb = corrIt->other_y;

    // Compute the terms:
    SumXa+=xa;
    SumYa+=ya;

    SumXb += xb;
    SumYb += yb;

    Sxx += xa * xb;
    Sxy += xa * yb;
    Syx += ya * xb;
    Syy += ya * yb;
}	// End of "for all correspondences"...

const float	mean_x_a = SumXa * N_inv;
const float	mean_y_a = SumYa * N_inv;
const float	mean_x_b = SumXb * N_inv;
const float	mean_y_b = SumYb * N_inv;

// Auxiliary variables Ax,Ay:
const float Ax = N*(Sxx + Syy) - SumXa*SumXb - SumYa*SumYb;
const float Ay = SumXa * SumYb + N*(Syx-Sxy)- SumXb * SumYa;

out_transformation.phi = (Ax!=0 || Ay!=0) ? atan2( static_cast<double>(Ay), static_cast<double>(Ax)) : 0.0;

const double ccos = cos( out_transformation.phi );
const double csin = sin( out_transformation.phi );

out_transformation.x = mean_x_a - mean_x_b * ccos + mean_y_b * csin;
out_transformation.y = mean_y_a - mean_x_b * csin - mean_y_b * ccos;
```

其中${\bar x}^a,{\bar y}^a,{\bar x}^b,{\bar y}^b$分别是向量${\rm x}^a,{\rm y}^a,{\rm x}^b,{\rm y}^b$的均值（平均值），它们包含了地图a和b中的特征的2-D坐标，我们还引入了辅助标量项$\Delta_x$和$\Delta_y$，定义为：

![eq-11](../Pictures/eq-11.png)

N=| C i |表示Ci中的配对数。

等式（10）中的最优变换可以被看作是六个辅助变量的函数q*i= q（z），我们可以将其叠加到向量${\rm z}=[{\bar x}^a \, {\bar y}^a \, {\bar x}^b \, {\bar y}^b \, \Delta_x \, \Delta_y]^{\top}$中。为了估计最佳变换的不确定性建立的协方差矩阵Qi模型，我们使用一阶不确定性传播，首先需要辅助变量z向量的多元高斯分布。该向量是所有特征${\rm x}^a,{\rm y}^a,{\rm x}^b,{\rm y}^b$（都是已知的输入数据）的二维坐标的函数。假设这些坐标被由已知协方差矩阵${\rm X}^a,{\rm Y}^a,{\rm X}^b,{\rm Y}^b$组成的附加的零均值高斯噪声一起破坏，我们可以通过以下来逼近z的协方差：

![eq-12]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/eq-12.png)

由于z依赖于整个特征坐标集，因此Jacobian矩阵${\rm J}_z=\frac{\partial {\rm z}}{\partial \{{\rm x}^a,{\rm y}^a,{\rm x}^b,{\rm y}^b\}}$的维数为6×4N。尽管公式（12）中涉及的矩阵很大，但由于特征协方差的以下特性，可以进行重要的简化：

- 因为在大多数特征检测器中，每个点都是独立检测的，所以不同特征坐标中的高斯误差是不相关的。
- 作为这种独立检测的结果，所有特征可以被赋予相同的协方差。
- 对于大多数感兴趣的点检测器来说，假设定位误差为各向同性分布是可行的。

这些假设在计算机视觉文献[9，31，32，35]中被广泛接受。综上所述，似乎可以接受${\rm X}^a,{\rm Y}^a,{\rm X}^b,{\rm Y}^b$是对所有坐标具有相同方差的对角矩阵，我们将其命名为σp2。通过将等式（12）中的协方差矩阵替换成值，我们得到以下对角矩阵：

![eq-13]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/eq-13.png)

其中$\beta$为：

![eq-14]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/eq-14.png)

其中常数σ̂xa2、σ̂ya2、σ̂xb2和σ̂yb2表示对应向量方差的无偏估计。

此时，我们可以继续推导q⋆i的协方差。通过计算式（10）关于z的雅可比，${\rm J}_q=\frac{{\rm q}^*_i}{\partial {\rm z}}$，得出协方差Qi与单个特征的不确定性σp2成正比，即：

![eq-15](../Pictures/eq-15.png)

其中，矩阵项由下式给出：

![eq-16]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/eq-16.png)

为了说明这种协方差估计的一些结果，从四组特征对应计算出的变换如图7所示，以及它们对于$[x^*_i \, y^*_i]^{\top}$的二维不确定椭圆和对φ⋆i的密度。这些例子说明了由此产生的不确定性的一些有趣的性质。首先，由于分布在更大区域上的特征可以作出更精确的估计，因此方向φ⋆i的不确定性强烈地依赖于特征的空间分布。通过比较图7（b）–（c）所示的两种情况，可以清楚地观察到这一点。其次，q⋆i的二维坐标的不确定度随特征数N的增加而减小，仅当N的值很低时。这可以通过术语2/N在C11和C22的表达式中变得可以忽略来解释，其中第二个术语不因N的值越来越大而减少。

![7]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/7.png)

图7：两个合成地图a和b之间的四组对应关系，用于不同的空间分布和检测特征的数量。这里，所有特征的位置不确定度都设置为σp=0.10，椭圆表示95%的置信区间。公式（7）中使用的在不同地图中测量的特征间距离dA和dB在（a）中作为示例示出。

为了验证我们的协方差Qi模型，我们评估了我们的模型与蒙特卡罗模拟得到的协方差之间的Kullback-Leibler散度，该模拟包含了受高斯噪声污染的随机定位特征之间的6对对应。图8中的结果表明，随着蒙特卡罗试验次数的增加，实验获得的协方差接近理论模型。

![8]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/8.png)

图8：随着越来越多的试验，协方差Qi的理论模型与蒙特卡罗模拟结果之间的Kullback-Leibler散度趋势。由于对由随机定位特征生成的50个不同地图计算了每个点的值，因此显示了KLD的置信区间。

在这一点上，我们已经描述了一个封闭形式，最优解的地图变换，并为任何给定的对应集推导出其相关联的不确定性的高斯近似。在第6节讨论的RANSAC阶段，特别是在算法1中表示为**opt_ transf**的步骤中，需要导出表达式。

## RESULTS

在本节中，我们将介绍旨在测试我们的方法的稳健性的实验。对于所有这些结果，我们使用Harris角点检测器和线性极坐标描述子来建立10cm分辨率栅格地图之间的对应关系。

### PERFORMANCE UNDER ERRORS AND NOISE

移动机器人在不同时刻绘制的地图，由于目标的动态性和地图绘制过程中的定位误差，可能会呈现出显著的差异。为了量化我们的方法对这些差异的准确性，我们将从真实数据构建的参考地图与已知地面真值平移和旋转的转换地图进行了匹配-参见图9中的左栏。

![9]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/9.png)

图9：在存在定位误差（σp）和激光传感器误差（σl）的情况下，我们的方法的特征。地图变换中的平均误差（来自SOG中最可能的高斯模式）和地图对之间的平均匹配次数由粗线表示，而±1-sigma置信区间由阴影区域表示。

已经评估了两个错误源。首先，环境中估计的机器人路径（进而决定地图本身的精度[16]）被高斯噪声故意破坏，标准偏差为σp。随着σp的增加，测试图的退化也会增加，如图顶行所示。可以看出，随着σp的增大，我们的方法所检测到的地图变换中的相应误差是如何增加的，这可以通过图中最右边一栏中所示的检测到的特征的错误位置和它们的重复性降低来解释。请注意，**重复性是任何特征检测器所期望的特性，因为它确保在两个不同的地图中检测到相同的物理点，而不管方向的潜在变化或特征周围的微小差异**。为了完整起见，我们还用一个标准的RANSAC实现重复了这个实验。请注意，因为在这个测试图中不存在多假设匹配的机会（即，MAP不存在真正的歧义）标准RANSAC的精度应该与我们的方法相匹配，这确实是我们所验证的。

其次，我们还评估了激光扫描仪范围内噪声的影响，其特征是标准偏差σl。如图9所示，我们的方法对这种误差不太敏感，可能是因为地图图像的预处理平滑了部分噪声测量。

我们必须指出，在这个特征中探测到的误差和噪声水平远远高于现实条件下的期望值（现实值的范围在图中标出）。因此，我们的方法在正常条件下的误差预计在10cm以下。

### PERFORMANCE IN LOOP-CLOSURE DETECTION

下面的基准描述了我们的方法在层次SLAM[5，12]的自然应用中的性能，即在从局部度量子图检测循环闭包中的性能。为此，我们选择了四个公开可用的数据集。其中三个是弗莱堡校区数据集、英特尔数据集和麻省理工学院数据集，发布在Radish repository[21]中，第四个是作者在Málaga校区5收集的。如图10所示，每个数据集的子图。

![10]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/10.png)

图10:（a）–（c）所建议方法检测到的地图对地图匹配的一些示例。（d）检测到多模态变换的一对子地图。这两个不同的假设由右手图像中的子图#20与子图#18的重叠来表示。

所有这些数据集都在我们的混合度量拓扑（HMT）SLAM框架中进行了处理，其他地方也有介绍[5]。在这个框架中，机器人观察的原始序列根据自然相似性度量被分成连续观察的片段（子图）[6]。为了方便起见，我们在这个框架中禁用了拓扑环路闭合检测，以获得每个数据集中的子图的原始序列。其中，有些区域会出现几次对应的循环闭包。

这样得到的59个子图集是本文所提出方法的理想测试平台，因为我们现在可以尝试将每个子图与其余子图相匹配，包括不同数据集中的子图（不应导致有效变换）。执行1711地图对地图匹配的详细结果如图11所示，其中表中的每个条目指定了我们方法的结果以及两个地图是否实际对应，即，它显示了环路闭合地面真相（通过人工检查获得）。注意，在本实验中有两种可能的错误：假阳性（我们检测出实际不存在的环路闭合）和假阴性（忽略实际环路闭合）。在全局SLAM中，前者更为重要，因为一个假阳性可能会彻底毁掉这张地图。但是，请注意，在HMT-SLAM中，如果度量信息的不确定性不太高，只要可以丢弃，候选假阳性可能就不是那么关键了[5]。

如图所示，我们的方法正确地将属于不同数据集的每个子图的所有情况检测为不匹配。有两个数据集值得注意。首先，Intel数据集会导致多个假阳性，这解释为环境的对称性，即它的所有子图都非常相似。第二，2006年的马拉加校园数据集也有许多假阳性，其中大部分是由于由三栋完全相同的建筑组成的环境造成的。如前所述，这是一种潜在的误差，通过检查层次地图中的闭环假设和度量信息的一致性，可以在后阶段容易地丢弃。

表1还总结了总体性能，其中为了公平验证，我们不计算图11的主对角线中的元素（将每个子图与自身匹配），这些元素是通过我们的方法正确检测到的。值得注意的是，41个环路中只有一个没有被识别（失败率为2.4%）。在表中我们还显示了通过忽略明显归因于真实重复环境的错误而不是我们的检测方法中的错误而修改的误报率。

![table-1]((2013) A Robust, Multi-Hypothesis Approach to Matching Occupancy.assets/table-1.png)

关于这个基准的计算时间，在奔腾酷睿2.2GHz（使用一个执行线程）中计算1711次匹配需要1740秒，平均每次匹配需要1.02秒。注意，这包括检测和描述符提取阶段，而不仅仅是描述符匹配。

## CONCLUSIONS

在这篇文章中，基于现有的计算机视觉技术（检测器和描述符），我们提出了一种新的网格匹配方法，并通过多假设RANSAC阶段的手段提供通常发现在我们的问题中的歧义所需的修改。实验结果表明，该方法在检测环路闭合的成功率为97%的同时，对传感器噪声和机器人定位误差也具有较高的可靠性。与以往的研究相比，我们的方案不依赖于对机器人航向的准确认识，从而使其适用于大量的现实世界的SLAM问题。同时，通过保持问题在整个过程中的概率性，包括可能的多模态分布，我们的方法在大规模环境下的分层机器人地图构建中有着重要而直接的应用。